<!DOCTYPE html>
<html>
<head>
    <title>Task Manager</title>
    <style>
        .hidden { display: none; }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .completed {
            color: green;
            font-weight: bold;
            text-align: center;
        }
        .small-btn {
            padding: 4px 8px;
            font-size: 0.8em;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
        }
        #message {
            margin-top: 10px;
            font-weight: bold;
            color: green;
        }
        #error {
            margin-top: 10px;
            font-weight: bold;
            color: red;
        }
    </style>
</head>
<body>

<div id="home">
    <h1>Task Manager</h1>
    <button onclick="showView('tasks'); loadTasks();">View Tasks</button>
    <button onclick="showCreateForm();">Create New Task</button>
</div>

<div id="tasks" class="hidden">
    <h1>Task List</h1>
    <button onclick="showView('home');">Home</button>
    <div id="taskTableContainer"></div>
</div>

<div id="create_edit" class="hidden">
    <h1 id="formTitle">Create Task</h1>
    <form id="taskForm" onsubmit="submitTaskForm(event);">
        <input type="hidden" name="id" id="taskId" />
        <label>Title:<br />
            <input type="text" name="title" id="title" required />
        </label><br />
        <label>Description:<br />
            <input type="text" name="description" id="description" required />
        </label><br />
        <label>Due Date:<br />
            <input type="date" name="due_date" id="due_date" required />
        </label><br />
        <label>
            <input type="checkbox" name="done" id="done" />
            Done
        </label><br /><br />
        <input type="submit" value="Create Task" id="submitBtn" />
        <button type="button" onclick="cancelForm();">Cancel</button>
    </form>
    <div id="message"></div>
    <div id="error"></div>
</div>

<script>
function showView(viewId) {
    document.getElementById('home').classList.add('hidden');
    document.getElementById('tasks').classList.add('hidden');
    document.getElementById('create_edit').classList.add('hidden');
    document.getElementById(viewId).classList.remove('hidden');
    document.getElementById('message').textContent = '';
    document.getElementById('error').textContent = '';
}

function loadTasks() {
    fetch('/tasks')
    .then(response => response.json())
    .then(tasks => {
        if (!tasks || tasks.length === 0) {
            document.getElementById('taskTableContainer').innerHTML = '<p>No tasks found.</p>';
            return;
        }

        let html = `<table>
            <thead>
                <tr>
                    <th>Title</th><th>Description</th><th>Due Date</th><th>Done</th><th>Actions</th>
                </tr>
            </thead><tbody>`;

        tasks.forEach(task => {
            html += `<tr>
                <td>${task.title}</td>
                <td>${task.description}</td>
                <td>${task.due_date || ''}</td>
                <td class="completed">${task.done ? 'âœ“' : ''}</td>
                <td>
                    <button class="small-btn" onclick="editTask(${task.id})">Edit</button>
                    <button class="small-btn" onclick="deleteTask(${task.id})">Delete</button>
                </td>
            </tr>`;
        });

        html += '</tbody></table>';
        document.getElementById('taskTableContainer').innerHTML = html;
    })
    .catch(() => {
        document.getElementById('taskTableContainer').innerHTML = '<p>Error loading tasks.</p>';
    });
}

function showCreateForm() {
    showView('create_edit');
    document.getElementById('formTitle').textContent = 'Create Task';
    document.getElementById('submitBtn').value = 'Create Task';
    document.getElementById('taskForm').reset();
    document.getElementById('taskId').value = '';
}

function cancelForm() {
    showView('tasks');
    loadTasks();
}

function submitTaskForm(event) {
    event.preventDefault();

    const id = document.getElementById('taskId').value;
    const taskData = {
        title: document.getElementById('title').value,
        description: document.getElementById('description').value,
        due_date: document.getElementById('due_date').value,
        done: document.getElementById('done').checked
    };

    let url = '/tasks';
    let method = 'POST';

    if (id) {
        url += '/' + id;
        method = 'PUT';
    }

    fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(taskData)
    })
    .then(response => {
        if (!response.ok) throw new Error('Network response was not ok');
        document.getElementById('message').textContent = id ? 'Task updated successfully!' : 'Task created successfully!';
        showView('tasks');
        loadTasks();
    })
    .catch(() => {
        document.getElementById('error').textContent = id ? 'Failed to update task.' : 'Failed to create task.';
    });
}

function editTask(id) {
    fetch('/tasks/' + id)
    .then(response => response.json())
    .then(task => {
        showView('create_edit');
        document.getElementById('formTitle').textContent = 'Edit Task';
        document.getElementById('submitBtn').value = 'Update Task';
        document.getElementById('taskId').value = task.id;
        document.getElementById('title').value = task.title;
        document.getElementById('description').value = task.description;
        document.getElementById('due_date').value = task.due_date;
        document.getElementById('done').checked = task.done;
        document.getElementById('message').textContent = '';
        document.getElementById('error').textContent = '';
    })
    .catch(() => alert('Failed to load task for editing.'));
}

function deleteTask(id) {
    if (!confirm('Are you sure you want to delete this task?')) return;
    fetch('/tasks/' + id, { method: 'DELETE' })
    .then(() => loadTasks())
    .catch(() => alert('Failed to delete task.'));
}


showView('home');
</script>

</body>
</html>
